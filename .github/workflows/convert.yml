name: Convert spot prices to hourly

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests pytz

      - name: Generate hourly.json
        run: |
          mkdir -p public
          python3 - << 'EOF'
          import requests, json, datetime, pytz
          url = "https://spot.utilitarian.io/electricity/FI/latest/"
          data = requests.get(url).json()
          tz = pytz.timezone("Europe/Helsinki")
          hours = {}
          for i in range(0, len(data), 4):
              block = data[i:i+4]
              avg = sum(float(x["value"]) for x in block) / len(block)
              t = datetime.datetime.fromisoformat(block[0]["timestamp"]).astimezone(tz)
              hours[f"{i//4}.0"] = {
                  "time": t.strftime("%Y-%m-%d %H:%M:%S%z"),
                  "price": round(avg, 3)
              }
          output = {
              "hourly_prices": hours,
              "meta": {
                  "bidding_zone": "FI",
                  "timezone": "Europe/Helsinki",
                  "generated_at": datetime.datetime.now(tz).strftime("%Y-%m-%d %H:%M:%S%z"),
                  "units": "EUR/MWh",
                  "resolution": "1H"
              }
          }
          with open("public/hourly.json", "w") as f:
              json.dump(output, f, indent=2)
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
